<!doctype html>
<html lang="en-us">
    <head>
        <title>Vipster</title>
        <meta charset="utf-8">
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
        <meta name="viewport" content="width=device-width,user-scalable=no">
        <style>
            body{
                font-family: arial;
                margin: 0;
                padding: none;
                -moz-user-select: none;
                user-select: none;
            }
            canvas.emscripten{
                border:0px none;
                margin: 0px;
                background-color: white;
                width: 80vw;
                height: 80vh;
                display: inline-block;
            }
            ul#molList{
                display: inline-block;
                vertical-align: top;
                list-style-type: none;
            }
        </style>
    </head>

    <body>
        <div id="upload">
            <input type="file" id="upfile" name="file" style="display: none;">
            <button type="button" id="upfilebut" onclick="document.getElementById('upfile').click()">Browse...</button>
            <select id="uptype" name="type">
                <option value="0">XYZ</option>
                <option value="1">PWScf Input</option>
                <option value="2">Lammps Input</option>
                <option value="3">Lammps Trajectory</option>
            </select>
            <button type="button" id="upbut">Upload</button>
        </div>

        <div id="mult">
            X: <input type="number" id="xmult" min="1" value="1">
            Y: <input type="number" id="ymult" min="1" value="1">
            Z: <input type="number" id="zmult" min="1" value="1">
        </div>

        <ul id="molList">
            <li class="molBut" onclick="setMol(getMolListIdx(event.target))">Example</li>
        </ul>

        <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()"></canvas>

        <div id="stepSel">
            <input type="range" id="stepSlider" min="0" max="0" value="0">
            <span id="stepCur">1</span>
            /
            <span id="stepMax">1</span>
        </div>

        <output id="output"></output>

        <script async type="text/javascript" src="js/vipster.js"></script>

        <script type="text/javascript">
            var Module = {
                preRun: [],
                postRun: [],
                curMol: 0,
                curStep: 0,
                canvas: (function() {
                  var canvas = document.getElementById('canvas');
                  canvas.addEventListener("webglcontextlost", function(e) { alert('WebGL context lost. You will need to reload the page.'); e.preventDefault(); }, false);
                  canvas.width = canvas.clientWidth;
                  canvas.height = canvas.clientHeight;
                  return canvas;
                })(),
            };
            window.addEventListener("resize", function(e){ Module.canvas.width=Module.canvas.clientWidth; Module.canvas.height=Module.canvas.clientHeight;}, false);

            function readFile(e){
                var file = document.getElementById('upfile').files[0];
                var reader = new FileReader();
                var molList = document.getElementById('molList');
                reader.onload = function(e){
                    molList.innerHTML += ('<li onclick="setMol(getMolListIdx(event.target))">'+file.name+"</li>");
                    Module.FS_createDataFile("/tmp","test.file", e.target.result, true);
                    Module.readFile("/tmp/test.file", file.name, parseInt(document.getElementById('uptype').value));
                    Module.FS_unlink("/tmp/test.file")
                    setMol(molList.childElementCount-1);
                };
                reader.readAsText(file);
                document.getElementById('output').innerHTML = "Success!";
            };
            document.getElementById('upbut').addEventListener('click', readFile, false);

            function setMult(e){
                var x = document.getElementById('xmult').value;
                var y = document.getElementById('ymult').value;
                var z = document.getElementById('zmult').value;
                Module.setMult(parseInt(x),parseInt(y),parseInt(z));
            }
            document.getElementById('mult').addEventListener('change', setMult, false);

            function getMolListIdx(li){
                var molList = li.parentElement.children;
                for(i=0;i<li.parentElement.childElementCount;i++){
                    if (li == molList[i]) break;
                }
                return i;
            }

            function setMol(i){
                Module.curMol = i;
                var nstep = Module.getMolNStep(i);
                var slider = document.getElementById('stepSlider');
                document.getElementById('stepMax').innerHTML = nstep;
                document.getElementById('stepCur').innerHTML = 1;
                slider.value = 0;
                slider.max = nstep-1;
                Module.curStep = 0;
                Module.setStep(i, 0);
            }

            function setStep(e){
                var i = parseInt(e.target.value);
                document.getElementById('stepCur').innerHTML = i+1;
                Module.curStep = i;
                Module.setStep(Module.curMol, i);
            }
            document.getElementById('stepSlider').addEventListener('input', setStep, false);
        </script>
    </body>
</html>
